# 传送一张图片文件的网络协议设计

协议的设计很简单，如下:

+---------------+--------+-------------------------+
| Magic Num     |  u32   |       0x930909          |
+---------------+--------+-------------------------+
| ver num       |  u16   |       1                 |
+---------------+--------+-------------------------+
| file_name len |  u16   |    file name bytes      |
+---------------+--------+-------------------------+
| file name     |  bytes |    UTF-8 String         |
+---------------+--------+-------------------------+
| file size     |  u32   |    file content bytes   |
+---------------+--------+-------------------------+
| file content  |  bytes |    real file data       |
+---------------+--------+-------------------------+

其中前四个字节是魔数，紧跟着的是版本号，然后是文件名长度、文件名、文件大小、文件内容数据


最终需要将其按照如下格式放在一个平坦的内存位置，例如字节数组内被发送前

> | Magic num | ver num | file_name_len | file_name | file_size | real_file_content_data |


## 第二版 -- 修改协议使得可以流式传输

file content 文件内容与header分开传输

1. 先把header正常编码发送

2. 再开创一个固定的例如4KB、8KB大小的缓冲区一次读满，然后发送，循环这个步骤直到文件结尾

+---------------+--------+-------------------------+
| Magic Num     |  u32   |       0x930909          |
+---------------+--------+-------------------------+
| ver num       |  u16   |       1                 |
+---------------+--------+-------------------------+
| file_name len |  u16   |    file name bytes      |
+---------------+--------+-------------------------+
| file name     |  bytes |    UTF-8 String         |
+---------------+--------+-------------------------+
| file size     |  u32   |    file content bytes   |
+---------------+--------+-------------------------+

> 受限于u32类型，最大仅支持4GB大小的文件，如果需要更大的文件支持，使用u64类型

需要注意的是:

1. 并没有在协议层指定header + body的规则，而是先发送正常的一个总结性质的编码内容
2. 然后再发送文件主体内容

在协议层面不是 header + body的形式，仅仅只是分开传输

分开传输有利于方便实现流式传输


具体是:

1. 先将文件meta信息编码然后发送
2. 循环发送文件内容，一次只读只发送固定大小
